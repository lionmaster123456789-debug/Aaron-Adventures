<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AARON ADVENTURES: SINGULARITY VANGUARD</title>
    <style>
        /* 
         * GLOBAL STYLING 
         * Hochwertiges Cyberpunk-Interface
         */
        @import url('https://fonts.googleapis.com');

        :root {
            --p-color: #00ff88;
            --s-color: #ff0044;
            --bg-dark: #020205;
            --panel-bg: rgba(0, 0, 0, 0.85);
            --border-glow: 0 0 20px rgba(0, 255, 136, 0.4);
        }

        body, html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Orbitron', sans-serif;
            color: #fff;
            width: 100vw;
            height: 100vh;
        }

        canvas {
            display: block;
            image-rendering: auto;
            filter: contrast(1.1) saturate(1.3);
        }

        /* 
         * UI LAYERS 
         */
        #ui-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 100;
        }

        .hud-container {
            position: absolute;
            top: 40px;
            left: 40px;
            background: var(--panel-bg);
            border-left: 6px solid var(--p-color);
            padding: 25px 40px;
            backdrop-filter: blur(20px);
            border-radius: 0 20px 20px 0;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .lvl-label {
            font-size: 12px;
            letter-spacing: 5px;
            color: var(--p-color);
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .lvl-display {
            font-size: 56px;
            font-weight: 900;
            color: #fff;
            line-height: 1;
            text-shadow: 0 0 25px var(--p-color);
        }

        /* 
         * MENU SYSTEM 
         */
        #main-menu {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, #101525 0%, #000 100%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1);
        }

        .menu-title-group {
            text-align: center;
            margin-bottom: 60px;
        }

        .title-main {
            font-size: 110px;
            letter-spacing: 35px;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 70px var(--p-color);
            margin: 0;
            text-transform: uppercase;
        }

        .title-sub {
            font-size: 20px;
            color: var(--s-color);
            letter-spacing: 18px;
            font-weight: 700;
            margin-top: -15px;
            text-transform: uppercase;
        }

        /* 
         * SKIN VAULT 
         */
        .vault-grid {
            display: flex;
            gap: 25px;
            margin: 40px 0;
            perspective: 2000px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 900px;
        }

        .skin-card {
            width: 130px;
            height: 160px;
            background: rgba(255,255,255,0.03);
            border: 2px solid #222;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.5s cubic-bezier(0.23, 1, 0.32, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .skin-card.unlocked:hover {
            transform: translateZ(50px) rotateY(15deg);
            border-color: var(--p-color);
            box-shadow: 0 0 50px var(--p-color);
        }

        .skin-card.selected {
            border-color: var(--p-color);
            background: rgba(0, 255, 136, 0.15);
            box-shadow: 0 0 60px var(--p-color);
        }

        .skin-card.locked {
            opacity: 0.15;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .skin-preview-box {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 2px solid transparent;
        }

        .btn-action {
            background: transparent;
            color: #fff;
            border: 2px solid #fff;
            padding: 25px 120px;
            font-size: 32px;
            font-weight: 900;
            cursor: pointer;
            letter-spacing: 12px;
            transition: 0.4s;
            border-radius: 10px;
            margin-top: 40px;
            text-transform: uppercase;
        }

        .btn-action:hover {
            background: #fff;
            color: #000;
            box-shadow: 0 0 100px #fff;
            transform: translateY(-10px);
        }

        .vignette {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, transparent 40%, black 160%);
            pointer-events: none;
            z-index: 50;
        }

        #terminal-log {
            position: absolute;
            bottom: 30px;
            right: 40px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--p-color);
            opacity: 0.6;
            text-align: right;
            line-height: 1.6;
        }
    </style>
</head>
<body>

<div id="ui-layer">
    <div class="hud-container">
        <div class="lvl-label">CORE_SECTOR_LINK</div>
        <div id="lvlDisplay" class="lvl-display">01</div>
        <div id="biomeLabel" style="color: #666; font-size: 14px; margin-top: 8px; letter-spacing: 3px;">SCANNING...</div>
    </div>
    <div id="terminal-log">
        STATUS: SYSTEMS_VANGUARD_OPTIMIZED<br>
        BUFFER: 20000_OPS_PER_CYCLE<br>
        LOCAL_STORAGE: SYNCED
    </div>
</div>

<div id="main-menu">
    <div class="menu-title-group">
        <h1 class="title-main">AARON</h1>
        <div class="title-sub">SINGULARITY VANGUARD</div>
    </div>
    
    <div class="vault-grid" id="skinVault">
        <!-- JS INJECTED -->
    </div>
    
    <button class="btn-action" onclick="VanguardCore.launch()">INITIALIZE</button>
</div>

<div class="vignette"></div>
<canvas id="gameStage"></canvas>

<script>
/**
 * AARON ADVENTURES: SINGULARITY VANGUARD
 * -----------------------------------------
 * ARCHITECTURE: MODULE-BASED ECS
 * PHYSICS: SUB-PIXEL INTEGRATION
 * VERSION: 6.0.0
 * -----------------------------------------
 */

// --- GLOBAL CONFIGURATION ---
const CONFIG = {
    fixedDelta: 1000 / 60, // 60 FPS Fixed Step
    gravity: 0.92,
    friction: 0.84,
    jumpImpulse: -21,
    maxFallSpeed: 28,
    coyoteFrames: 12,
    jumpBufferFrames: 10,
    distMin: 220,
    distMax: 380,
    playerWidth: 54,
    playerHeight: 54
};

// --- DATA SETS ---
const BIOMES = [
    { name: "Neon District", bg: "#020205", p: "#00ff88", s: "#004422", fx: "grid" },
    { name: "Organic Core", bg: "#050a05", p: "#ccff00", s: "#3d4d00", fx: "vines" },
    { name: "Cryo Archive", bg: "#050a15", p: "#00d2d3", s: "#005577", fx: "snow" },
    { name: "Magma Forge", bg: "#100505", p: "#ff4400", s: "#551100", fx: "embers" },
    { name: "Void Prism", bg: "#080010", p: "#9b59b6", s: "#440066", fx: "stars" }
];

const SKINS = [
    { name: "Vanguard", c1: "#1e272e", c2: "#485460", eye: "#ff3f34", glow: "rgba(255, 63, 52, 0.6)" },
    { name: "Phantom", c1: "#000000", c2: "#1a1a1a", eye: "#00ff88", glow: "rgba(0, 255, 136, 0.6)" },
    { name: "Arctic", c1: "#d2dae2", c2: "#f5f6fa", eye: "#00a8ff", glow: "rgba(0, 168, 255, 0.6)" },
    { name: "Ignis", c1: "#2c3e50", c2: "#c23616", eye: "#fbc531", glow: "rgba(241, 196, 15, 0.6)" },
    { name: "Omega", c1: "#130f40", c2: "#30336b", eye: "#be2edd", glow: "rgba(190, 46, 221, 0.6)" },
    { name: "Zenith", c1: "#fbc531", c2: "#e1b12c", eye: "#ffffff", glow: "rgba(255, 255, 255, 0.8)" }
];

// --- CORE ENGINE ---
const VanguardCore = (function() {
    let canvas, ctx;
    let width, height;
    let loopId, lastTime = 0, accumulator = 0;
    
    let gameState = 'MENU';
    let currentLvl = 1;
    let skinIdx = 0;
    let cameraX = 0;

    let world = {
        platforms: [],
        hazards: [],
        particles: [],
        fx: [],
        parallax: []
    };

    const player = {
        x: 0, y: 0,
        vx: 0, vy: 0,
        grounded: false,
        coyote: 0,
        buffer: 0,
        rot: 0,
        dead: false,
        win: false
    };

    const inputs = {};

    function init() {
        canvas = document.getElementById('gameStage');
        ctx = canvas.getContext('2d');
        
        window.addEventListener('resize', resize);
        window.addEventListener('keydown', e => inputs[e.code] = true);
        window.addEventListener('keyup', e => inputs[e.code] = false);

        loadLocalStorage();
        resize();
        renderVaultUI();
        
        // Start Background Animation
        requestAnimationFrame(menuLoop);
    }

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }

    function loadLocalStorage() {
        const saved = localStorage.getItem('aaron_vanguard_v6');
        if (saved) {
            const data = JSON.parse(saved);
            currentLvl = data.lvl || 1;
            skinIdx = data.skin || 0;
        }
    }

    function saveLocalStorage() {
        localStorage.setItem('aaron_vanguard_v6', JSON.stringify({
            lvl: currentLvl,
            skin: skinIdx
        }));
    }

    function renderVaultUI() {
        const vault = document.getElementById('skinVault');
        vault.innerHTML = '';
        const unlockedCount = Math.floor((currentLvl - 1) / 5) + 1;

        SKINS.forEach((s, i) => {
            const card = document.createElement('div');
            card.className = `skin-card ${i < unlockedCount ? 'unlocked' : 'locked'} ${i === skinIdx ? 'selected' : ''}`;
            
            if (i < unlockedCount) {
                card.innerHTML = `
                    <div class="skin-preview-box" style="background:${s.c1}; border-color:${s.eye}; box-shadow:0 0 15px ${s.glow}"></div>
                    <div style="font-size:11px; color:#fff; font-weight:bold">${s.name}</div>
                `;
                card.onclick = () => {
                    skinIdx = i;
                    saveLocalStorage();
                    renderVaultUI();
                };
            } else {
                card.innerHTML = `
                    <div style="font-size:24px">ðŸ”’</div>
                    <div style="font-size:9px; color:#444; margin-top:10px">LVL ${i*5 + 1}</div>
                `;
            }
            vault.appendChild(card);
        });
    }

    function generateLevel(lvl) {
        world.platforms = [];
        world.hazards = [];
        world.particles = [];
        world.fx = [];
        world.parallax = [];
        
        cameraX = 0;
        player.x = 200;
        player.y = 400;
        player.vx = 0;
        player.vy = 0;
        player.dead = false;
        player.win = false;

        const biome = BIOMES[Math.floor((lvl - 1) / 10) % BIOMES.length];
        document.getElementById('lvlDisplay').innerText = lvl.toString().padStart(2, '0');
        document.getElementById('biomeLabel').innerText = "LOCATION: " + biome.name.toUpperCase();

        // Parallax Decorations
        for (let i = 0; i < 150; i++) {
            world.parallax.push({
                x: Math.random() * width * 10,
                y: Math.random() * height,
                z: Math.random() * 0.5 + 0.1,
                s: Math.random() * 4,
                o: Math.random()
            });
        }

        let lastX = 0;
        let lastY = 600;

        // Startplattform
        world.platforms.push(new Platform(0, 600, 700, 800, 'START', biome.p));

        const levelComplexity = 25 + Math.floor(lvl * 1.5);
        const dangerScale = Math.min(0.8, 0.1 + (lvl * 0.04));

        for (let i = 0; i < levelComplexity; i++) {
            // CHALLENGE DISTANCE: ErhÃ¶hte Sprungweite
            let pWidth = 200 + Math.random() * 300;
            let pGap = CONFIG.distMin + Math.random() * (CONFIG.distMax - CONFIG.distMin);
            let pX = lastX + pGap;
            let pY = lastY + (Math.random() * 300 - 150);
            
            // Grenzen einhalten
            pY = Math.max(250, Math.min(height - 250, pY));

            let type = 'NORM';
            const rnd = Math.random();
            if (lvl > 5 && rnd > 0.88) type = 'MOVING';
            if (lvl > 10 && rnd > 0.82) type = 'ICE';
            if (lvl > 15 && rnd > 0.75) type = 'FRAGILE';
            if (lvl > 20 && rnd > 0.7) type = 'BOOST';

            const block = new Platform(pX, pY, pWidth, 55, type, (i % 2 === 0 ? biome.p : biome.s));
            world.platforms.push(block);

            // Hindernisse hinzufÃ¼gen (15+ Logik)
            if (i > 3 && Math.random() < dangerScale) {
                let hType = (lvl < 10) ? 'SPIKE' : (Math.random() > 0.6 ? 'DRONE' : 'CANNON');
                if (lvl > 25 && Math.random() > 0.8) hType = 'LASER';
                
                world.hazards.push(new Hazard(pX + 60 + Math.random() * (pWidth - 120), pY - 50, hType));
            }

            lastX = pX + pWidth;
            lastY = pY;
        }

        // Ziel-Portal
        world.platforms.push(new Platform(lastX + 550, lastY - 100, 200, 1000, 'GOAL', '#00ff88'));
    }

    function launch() {
        document.getElementById('main-menu').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('main-menu').style.display = 'none';
            gameState = 'PLAY';
            generateLevel(currentLvl);
            
            lastTime = performance.now();
            if (loopId) cancelAnimationFrame(loopId);
            loopId = requestAnimationFrame(gameLoop);
        }, 800);
    }

    function gameLoop(timestamp) {
        if (gameState !== 'PLAY') return;

        const deltaTime = timestamp - lastTime;
        lastTime = timestamp;
        accumulator += deltaTime;

        // FIXED TIMESTEP UPDATE (Eliminiert Speed-Bug)
        while (accumulator >= CONFIG.fixedDelta) {
            update();
            accumulator -= CONFIG.fixedDelta;
        }

        render();
        loopId = requestAnimationFrame(gameLoop);
    }

    function menuLoop() {
        if (gameState !== 'MENU') return;
        // Simple Background Animation for Menu
        ctx.fillStyle = "#010105";
        ctx.fillRect(0, 0, width, height);
        requestAnimationFrame(menuLoop);
    }

    function update() {
        if (player.dead) {
            generateLevel(currentLvl);
            return;
        }

        if (player.win) {
            currentLvl++;
            saveLocalStorage();
            gameState = 'MENU';
            document.getElementById('main-menu').style.display = 'flex';
            document.getElementById('main-menu').style.opacity = '1';
            renderVaultUI();
            return;
        }

        // Horizontal Movement
        if (inputs['ArrowLeft'] || inputs['KeyA']) player.vx -= 1.6;
        if (inputs['ArrowRight'] || inputs['KeyD']) player.vx += 1.6;
        
        player.vx *= CONFIG.friction;
        player.vy += CONFIG.gravity;

        if (player.vy > CONFIG.maxFallSpeed) player.vy = CONFIG.maxFallSpeed;

        player.x += player.vx;
        player.y += player.vy;

        // Sub-Pixel Camera Smoothing
        let targetCam = player.x - width / 3.5;
        cameraX += (targetCam - cameraX) * 0.12;

        // Jump Logic (Coyote & Buffer)
        if (player.grounded) player.coyote = CONFIG.coyoteFrames;
        else player.coyote--;

        if (inputs['ArrowUp'] || inputs['Space'] || inputs['KeyW']) player.buffer = CONFIG.jumpBufferFrames;
        else player.buffer--;

        if (player.buffer > 0 && player.coyote > 0) {
            player.vy = CONFIG.jumpImpulse;
            player.buffer = 0;
            player.coyote = 0;
            player.grounded = false;
            // Jump Particles
            spawnParticles(player.x + 27, player.y + 50, '#fff', 10);
        }

        // Collision Pipeline
        player.grounded = false;
        world.platforms.forEach(p => {
            if (!p.active) return;
            
            // Moving Logic
            if (p.type === 'MOVING') p.y = p.oy + Math.sin(Date.now() / 500 + p.off) * 90;

            if (player.x + CONFIG.playerWidth > p.x && 
                player.x < p.x + p.w && 
                player.y + CONFIG.playerHeight > p.y && 
                player.y + CONFIG.playerHeight < p.y + p.h + 25 && 
                player.vy >= 0) {
                
                if (p.type === 'GOAL') {
                    player.win = true;
                    return;
                }

                player.y = p.y - CONFIG.playerHeight;
                player.vy = (p.type === 'BOOST') ? -34 : 0;
                player.grounded = true;

                if (p.type === 'FRAGILE') {
                    p.health -= 0.025;
                    if (p.health <= 0) p.shatter(world.particles);
                }
            }
        });

        // Hazard Processing
        world.hazards.forEach(h => {
            h.update(world.fx);
            let dist = Math.hypot((player.x + 27) - (h.x + 25), (player.y + 27) - (h.y + 25));
            if (dist < 45) player.dead = true;
        });

        // Projectile Processing
        world.fx = world.fx.filter(f => {
            f.x += f.vx;
            if (Math.hypot(player.x + 27 - f.x, player.y + 27 - f.y) < 30) player.dead = true;
            return f.x > cameraX - 100 && f.x < cameraX + width + 100;
        });

        // Particle Decay
        world.particles = world.particles.filter(pt => {
            pt.x += pt.vx;
            pt.y += pt.vy;
            pt.vy += 0.5;
            pt.o -= 0.02;
            return pt.o > 0;
        });

        if (player.y > height + 500) player.dead = true;
        player.rot += (player.vx * 0.05 - player.rot) * 0.12;
    }

    function spawnParticles(x, y, c, n) {
        for (let i = 0; i < n; i++) {
            world.particles.push({
                x, y, 
                vx: (Math.random() - 0.5) * 10,
                vy: (Math.random() - 0.5) * 10,
                c, o: 1, s: 4 + Math.random() * 8
            });
        }
    }

    function render() {
        const biome = BIOMES[Math.floor((currentLvl - 1) / 10) % BIOMES.length];
        
        // Background Pass
        ctx.fillStyle = biome.bg;
        ctx.fillRect(0, 0, width, height);

        // Parallax Pass
        ctx.fillStyle = "rgba(255,255,255,0.12)";
        world.parallax.forEach(s => {
            let sx = (s.x - cameraX * s.z) % (width + 800);
            if (sx < -400) sx += width + 800;
            ctx.fillRect(sx, s.y, s.s, s.s);
        });

        // Entities Pass
        world.platforms.forEach(p => p.draw(ctx, cameraX));
        world.hazards.forEach(h => h.draw(ctx, cameraX));
        world.fx.forEach(f => {
            ctx.fillStyle = "#ffea00";
            ctx.shadowBlur = 20;
            ctx.shadowColor = "orange";
            ctx.beginPath();
            ctx.arc(f.x - cameraX, f.y, 10, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
        });

        // Particles Pass
        world.particles.forEach(pt => {
            ctx.globalAlpha = pt.o;
            ctx.fillStyle = pt.c;
            ctx.fillRect(pt.x - cameraX, pt.y, pt.s, pt.s);
        });
        ctx.globalAlpha = 1.0;

        // AARON SKELETAL RENDER
        const skin = SKINS[skinIdx];
        ctx.save();
        ctx.translate(player.x - cameraX + 27, player.y + 27);
        ctx.rotate(player.rot);

        // Aura
        ctx.shadowBlur = 45;
        ctx.shadowColor = skin.glow;
        ctx.fillStyle = skin.c1;
        // Head
        ctx.beginPath();
        ctx.roundRect(-27, -27, 54, 54, 16);
        ctx.fill();
        
        ctx.shadowBlur = 0;
        // Armor
        ctx.fillStyle = skin.c2;
        ctx.fillRect(-27, -6, 54, 12);
        
        // Visor
        ctx.fillStyle = "#000";
        ctx.beginPath();
        ctx.roundRect(-27, -15, 54, 25, 6);
        ctx.fill();
        
        // Optics
        ctx.fillStyle = skin.eye;
        ctx.shadowBlur = 15;
        ctx.shadowColor = skin.eye;
        ctx.fillRect(-18, -10, 14, 6);
        ctx.fillRect(4, -10, 14, 6);
        
        // Scar
        ctx.strokeStyle = "rgba(255,0,0,0.5)";
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(12, -32);
        ctx.lineTo(20, -5);
        ctx.stroke();

        ctx.restore();
    }

    // CLASSES
    class Platform {
        constructor(x, y, w, h, type, color) {
            Object.assign(this, {x, y, w, h, type, color, oy: y, off: Math.random() * 10, health: 1.0, active: true});
        }
        shatter(particles) {
            this.active = false;
            for (let i = 0; i < 15; i++) {
                particles.push({
                    x: this.x + Math.random() * this.w,
                    y: this.y + Math.random() * this.h,
                    vx: (Math.random() - 0.5) * 15,
                    vy: -Math.random() * 15,
                    c: this.color, o: 1, s: 8 + Math.random() * 12
                });
            }
        }
        draw(ctx, camX) {
            if (!this.active) return;
            let sx = this.x - camX;
            ctx.save();
            ctx.globalAlpha = this.health;
            
            const grad = ctx.createLinearGradient(sx, this.y, sx, this.y + this.h);
            grad.addColorStop(0, this.color);
            grad.addColorStop(1, "#000");
            
            if (this.type === 'GOAL') {
                ctx.shadowBlur = 60;
                ctx.shadowColor = '#00ff88';
                ctx.fillStyle = '#00ff88';
            } else {
                ctx.fillStyle = grad;
            }

            ctx.beginPath();
            ctx.roundRect(sx, this.y, this.w, this.h, 12);
            ctx.fill();

            // Texture Overlay
            ctx.strokeStyle = "rgba(255,255,255,0.06)";
            for (let i = 15; i < this.w; i += 30) {
                ctx.beginPath(); ctx.moveTo(sx + i, this.y); ctx.lineTo(sx + i, this.y + this.h); ctx.stroke();
            }
            ctx.restore();
        }
    }

    class Hazard {
        constructor(x, y, type) {
            Object.assign(this, {x, y, type, t: 0});
        }
        update(fx) {
            this.t++;
            if (this.type === 'DRONE') this.x += Math.sin(this.t * 0.05) * 6;
            if (this.type === 'CANNON' && this.t % 120 === 0) {
                fx.push({ x: this.x, y: this.y + 20, vx: -12 });
            }
        }
        draw(ctx, camX) {
            let sx = this.x - camX;
            ctx.save();
            ctx.shadowBlur = 30;
            ctx.shadowColor = "#ff3f34";
            if (this.type === 'SPIKE') {
                ctx.fillStyle = "#ff3f34";
                ctx.beginPath();
                ctx.moveTo(sx, this.y + 45);
                ctx.lineTo(sx + 25, this.y);
                ctx.lineTo(sx + 50, this.y + 45);
                ctx.fill();
            } else if (this.type === 'DRONE') {
                ctx.fillStyle = "#fff";
                ctx.beginPath();
                ctx.arc(sx + 25, this.y + 25, 22, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = "#000";
                ctx.fillRect(sx + 10, this.y + 20, 30, 8);
            } else if (this.type === 'LASER') {
                if (Math.floor(this.t / 60) % 2 === 0) {
                    ctx.fillStyle = "rgba(255,0,0,0.8)";
                    ctx.fillRect(sx + 2
